#!/usr/bin/env bash
# Pre-commit hook for MakerWorld exports
#
# Exports all configured models and validates they are committed.
# This is the entry point called by pre-commit framework.
#
# Exit codes:
#   0 - All exports generated and committed
#   1 - Export failed or uncommitted changes detected

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# Run the export script
if ! "${PROJECT_ROOT}/cmd/export/export-core-models.sh"; then
    exit 1
fi

# Check if exported files have uncommitted/unstaged changes
cd "${PROJECT_ROOT}"
# Modified tracked files (not staged)
MODIFIED=$(git diff --name-only models/core/makerworld/ 2>/dev/null || true)
# Untracked files
UNTRACKED=$(git ls-files --others --exclude-standard models/core/makerworld/ 2>/dev/null || true)

if [ -n "$MODIFIED" ] || [ -n "$UNTRACKED" ]; then
    echo ""
    echo "ERROR: Exported MakerWorld files have uncommitted/unstaged changes"
    echo ""
    if [ -n "$MODIFIED" ]; then
        echo "Modified files (not staged):"
        echo "$MODIFIED"
    fi
    if [ -n "$UNTRACKED" ]; then
        echo "Untracked files:"
        echo "$UNTRACKED"
    fi
    echo ""
    echo "Run the following to stage them:"
    echo "  git add models/core/makerworld/"
    exit 1
fi

echo "âœ“ All exports are committed"
